# 2026年2月7日 完全実装サマリ

## 📊 作業概要

**作業日:** 2026年2月7日
**実装機能:** HareEntry（ハレの記録）CRUD機能の完全実装
**マージされたPR:** 5件（#66 〜 #70）
**コミット数:** 16コミット
**作業時間:** 約7時間（15:38 〜 21:38 JST）

---

## 🎯 実装した機能一覧

| PR | Issue | 機能 | 実装内容 |
|----|-------|------|---------|
| #66 | #22 | **Create** | モデル・テーブル作成、認証必須フォーム、enum による公開範囲管理 |
| #67 | #23 | **Read - Index** | ログインユーザーの投稿一覧、新しい順ソート、空状態UI |
| #68 | #24 | **Read - Show** | 詳細表示画面、一覧からのリンク、作成後の遷移先変更 |
| #69 | #25 | **Update** | 編集・更新処理、フォームパーシャル化、バリデーションエラー時の入力保持 |
| #70 | #26 | **Delete** | 削除機能、確認ダイアログ、スコープベース認可 |

**CRUD機能完成度:** ✅ 5/5 完了

---

## 🔧 技術的なポイント

### 1. セキュリティ・認可パターン

#### スコープ付きクエリによる認可

```ruby
# 全アクションで統一された認可パターン
def set_hare_entry
  @hare_entry = current_user.hare_entries.find(params[:id])
  # 他人のエントリの場合、ActiveRecord::RecordNotFound が発生し 404 になる
end
```

**仕組み:**
1. `current_user.hare_entries` で SQL に `WHERE user_id = ?` が自動追加される
2. `find(params[:id])` が `id = ? AND user_id = ?` の条件で検索
3. 条件に合致しない場合、`ActiveRecord::RecordNotFound` 例外が発生
4. Rails が自動的に 404 レスポンスに変換

**メリット:**
- コードが簡潔（if 文による権限チェック不要）
- セキュリティバグのリスク低減（チェック漏れがない）
- 404エラーで統一（存在しない or 権限なしを区別しない）

---

### 2. Rails 8 の enum 実装

#### enum の定義と内部動作

```ruby
# app/models/hare_entry.rb
class HareEntry < ApplicationRecord
  enum :visibility, { public_post: 0, private_post: 1 }
end
```

**Rails 8 の変更点:**
- Rails 7: `enum visibility: { public_post: 0, private_post: 1 }`
- Rails 8: `enum :visibility, { public_post: 0, private_post: 1 }` （キーワード引数形式）

**自動生成されるメソッド:**
```ruby
# 状態判定メソッド
@hare_entry.public_post?    # => true/false
@hare_entry.private_post?   # => true/false

# 状態変更メソッド
@hare_entry.public_post!    # visibility を 0 に変更して保存
@hare_entry.private_post!   # visibility を 1 に変更して保存

# スコープ
HareEntry.public_post       # visibility = 0 のレコードを取得
HareEntry.private_post      # visibility = 1 のレコードを取得
```

**DB への保存:**
- DB には整数値（0, 1）として保存される
- アプリケーション層ではシンボル（`:public_post`, `:private_post`）として扱える
- マイグレーション時のデータ変換が不要

---

### 3. before_action による共通処理の抽出

#### 処理フロー

```ruby
class HareEntriesController < ApplicationController
  before_action :authenticate_user!
  before_action :set_hare_entry, only: [:show, :edit, :update, :destroy]

  def show
    # @hare_entry は既にセット済み
  end

  private

  def set_hare_entry
    @hare_entry = current_user.hare_entries.find(params[:id])
  end
end
```

**実行順序:**
1. `authenticate_user!` が全アクションの前に実行
2. ログインしていない場合、ここでログイン画面にリダイレクト（以降の処理は実行されない）
3. `set_hare_entry` が指定アクションの前に実行（show, edit, update, destroy のみ）
4. 本来のアクションメソッドが実行

**メリット:**
- DRY原則（同じコードを複数のアクションに書かない）
- 認証・認可の処理が統一される
- コードの可読性向上

---

### 4. Strong Parameters によるマスアサインメント対策

#### 実装と仕組み

```ruby
def create
  @hare_entry = current_user.hare_entries.build(hare_entry_params)
  if @hare_entry.save
    redirect_to @hare_entry, notice: "ハレエントリを作成しました"
  else
    render :new, status: :unprocessable_entity
  end
end

private

def hare_entry_params
  params.require(:hare_entry).permit(:body, :occurred_on, :visibility)
end
```

**セキュリティ上の保護:**
- ユーザーが送信できるパラメータを明示的に制限
- 攻撃者が `user_id` や `id` などの危険なパラメータを送信しても無視される
- ホワイトリスト方式（許可したもののみ受け入れる）

**処理の流れ:**
1. `params.require(:hare_entry)` で `:hare_entry` キーが必須であることを強制
2. `.permit(:body, :occurred_on, :visibility)` で許可する属性を列挙
3. それ以外の属性は自動的に除外される

---

### 5. フォームパーシャルとローカル変数

#### パーシャルの設計

```erb
<!-- app/views/hare_entries/_form.html.erb -->
<%= form_with model: hare_entry, local: true do |f| %>
  <%= f.text_area :body %>
  <%= f.date_field :occurred_on, value: f.object.occurred_on || Date.today %>
  <%= f.select :visibility, HareEntry.visibilities.keys.map { |k| [k, k] } %>
  <%= f.submit submit_label, class: "btn btn-primary" %>
  <%= link_to "キャンセル", cancel_path, class: "btn" %>
<% end %>
```

**呼び出し側:**
```erb
<!-- new.html.erb -->
<%= render "form",
           hare_entry: @hare_entry,
           submit_label: "投稿する",
           cancel_path: root_path %>

<!-- edit.html.erb -->
<%= render "form",
           hare_entry: @hare_entry,
           submit_label: "更新する",
           cancel_path: hare_entry_path(@hare_entry) %>
```

**ポイント:**
- `hare_entry` ローカル変数で new/edit 両対応
- `f.object.occurred_on || Date.today` で新規作成時のデフォルト値を設定
- `submit_label` で送信ボタンのラベルを切り替え
- `cancel_path` でキャンセル時の遷移先を動的に変更

---

### 6. Turbo による非同期フォーム送信

#### Turbo の動作

```erb
<%= button_to "削除",
              hare_entry_path(@hare_entry),
              method: :delete,
              data: { turbo_confirm: "本当に削除しますか？" },
              class: "btn btn-error" %>
```

**処理フロー:**
1. ボタンクリック
2. `turbo_confirm` により確認ダイアログ表示
3. ユーザーがOKをクリック
4. Turbo が AJAX で DELETE リクエストを送信（ページ全体のリロードなし）
5. サーバーがリダイレクトレスポンスを返す
6. Turbo がリダイレクト先を fetch して表示

**従来の方法との違い:**
- 従来: ページ全体がリロードされる（画面がちらつく）
- Turbo: 必要な部分のみ更新される（スムーズな遷移）

---

### 7. バリデーションエラー時の UX

#### コントローラーでの処理

```ruby
def create
  @hare_entry = current_user.hare_entries.build(hare_entry_params)
  if @hare_entry.save
    redirect_to @hare_entry, notice: "ハレエントリを作成しました"
  else
    render :new, status: :unprocessable_entity
  end
end
```

**ポイント:**
- `save` が失敗した場合、`render :new` で同じフォームを再表示
- `status: :unprocessable_entity` (422) でエラーレスポンスを明示
- `@hare_entry` にはバリデーションエラー情報が含まれる
- フォームに入力した値は `@hare_entry` に保持されている

**ビュー側での表示:**
```erb
<% if hare_entry.errors.any? %>
  <div class="alert alert-error">
    <% hare_entry.errors.full_messages.each do |message| %>
      <p><%= message %></p>
    <% end %>
  </div>
<% end %>
```

---

### 8. リダイレクトと Flash メッセージ

#### 実装パターン

```ruby
def create
  @hare_entry = current_user.hare_entries.build(hare_entry_params)
  if @hare_entry.save
    redirect_to @hare_entry, notice: "ハレエントリを作成しました"
  else
    render :new, status: :unprocessable_entity
  end
end
```

**Flash の種類:**
- `notice`: 成功メッセージ（緑色で表示）
- `alert`: 警告・エラーメッセージ（赤色で表示）

**Flash の仕組み:**
1. `redirect_to` 時に session に保存される
2. リダイレクト先で1回だけ表示される
3. 表示後は自動的に削除される（次のリクエストでは表示されない）

**`render` との違い:**
- `redirect_to`: 新しいHTTPリクエストが発生（URLが変わる）、Flashが使える
- `render`: 同じリクエスト内でビューを表示（URLは変わらない）、Flashは使えない

---

### 9. button_to と link_to の違い

#### 生成されるHTML

```erb
<!-- button_to -->
<%= button_to "削除", hare_entry_path(@hare_entry), method: :delete %>
```

**生成されるHTML:**
```html
<form action="/hare_entries/1" method="post">
  <input type="hidden" name="_method" value="delete" />
  <input type="hidden" name="authenticity_token" value="..." />
  <button type="submit">削除</button>
</form>
```

```erb
<!-- link_to -->
<%= link_to "削除", hare_entry_path(@hare_entry), method: :delete, data: { turbo_method: :delete } %>
```

**生成されるHTML:**
```html
<a href="/hare_entries/1" data-turbo-method="delete">削除</a>
```

**比較:**

| 項目 | `button_to` | `link_to` |
|------|-------------|-----------|
| 生成要素 | `<form>` + `<button>` | `<a>` タグ |
| DELETE対応 | HTML標準の仕組み（`_method` hidden field） | JavaScript/Turbo に依存 |
| JavaScript無効時 | ✅ 動作する | ❌ 動作しない |
| CSRF対策 | ✅ `authenticity_token` 自動付与 | △ Turbo に依存 |
| アクセシビリティ | ✅ ボタンとして認識される | △ リンクとして認識される |
| 削除操作での推奨 | ✅ 推奨 | ❌ 非推奨 |

---

### 10. 空状態UI（Empty State）の実装

#### 実装例

```erb
<!-- app/views/hare_entries/index.html.erb -->
<% if @hare_entries.any? %>
  <% @hare_entries.each do |hare_entry| %>
    <!-- カード表示 -->
  <% end %>
<% else %>
  <div class="text-center py-12">
    <p class="text-gray-500 mb-4">まだハレの記録がありません</p>
    <%= link_to "最初のハレを記録する", new_hare_entry_path, class: "btn btn-primary" %>
  </div>
<% end %>
```

**UXの工夫:**
- データがない状態を明示的に示す
- 次のアクション（CTA: Call To Action）を提示
- ユーザーが迷わないようにガイドする

---

## 📈 プロジェクト進捗

### CRUD機能完成度

| 機能 | Issue | PR | ステータス |
|------|-------|----|----------|
| Create（作成） | #22 | #66 | ✅ 完了 |
| Read - Index（一覧） | #23 | #67 | ✅ 完了 |
| Read - Show（詳細） | #24 | #68 | ✅ 完了 |
| Update（編集） | #25 | #69 | ✅ 完了 |
| Delete（削除） | #26 | #70 | ✅ 完了 |

**HareEntry の基本CRUD機能が完全に実装されました！** 🎉

---

## 🎓 学習ポイント・ベストプラクティス

### 1. Rails 認可パターンの選択

```ruby
# ❌ 手動チェック（冗長、バグのリスク）
def destroy
  @hare_entry = HareEntry.find(params[:id])
  if @hare_entry.user_id != current_user.id
    redirect_to root_path, alert: "権限がありません"
    return
  end
  @hare_entry.destroy
end

# ✅ スコープベース（簡潔、安全）
def destroy
  @hare_entry = current_user.hare_entries.find(params[:id])
  @hare_entry.destroy!
  redirect_to hare_entries_path, notice: "削除しました"
end
```

### 2. フォーム実装の比較

| 項目 | `button_to` | `link_to` |
|------|-------------|-----------|
| 生成要素 | `<form>` + `<button>` | `<a>` タグ |
| DELETE対応 | ✅ ネイティブ対応 | ⚠️ JavaScript必要 |
| アクセシビリティ | ✅ 良好 | △ やや劣る |
| 削除操作での推奨 | ✅ 推奨 | ❌ 非推奨 |

### 3. パーシャル設計

```erb
<!-- new.html.erb -->
<%= render "form",
           hare_entry: @hare_entry,
           submit_label: "投稿する",
           cancel_path: root_path %>

<!-- edit.html.erb -->
<%= render "form",
           hare_entry: @hare_entry,
           submit_label: "更新する",
           cancel_path: hare_entry_path(@hare_entry) %>
```

**メリット:**
- DRY原則の徹底
- メンテナンス性の向上
- 一貫性のあるUI

---

**作業日:** 2026年2月7日
**作業時間:** 約7時間
**達成:** HareEntry CRUD機能完全実装 🎉
