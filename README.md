# ケハレ帖（仮） — 今日のごはんに、小さなハレを。

## 本サービスの概要（700文字以内）
ケハレ帖（仮）は、日常の食事（ケ）に「小さなハレ」を足す行動を、短文＋タグで記録し、カレンダーとポイントで振り返れるサービスです。献立相談では、状況（自炊/中食、買い物/家にある、時間、気分など）を選ぶだけで候補を得て、ワンタップで外部検索へ進めるため、検索疲れ・迷いを減らします。主な利用者は一人暮らしの料理初心者を想定し、無理な健康管理や完璧な自炊ではなく「できた」を積み上げる継続体験を提供します。

---

**ケハレ帖（仮）**は、日常（ケ）に「ハレ」を足して、ありきたりな毎日に彩を足す **記録・共有**サービスです。  
献立の“迷い”を減らしつつ、提案に頼らなくても「今日ハレを足した」行動が残せます。  
ハレの記録は **ポイント／見た目の成長** と **カレンダーのスタンプ**で可視化されます。

> * **コンセプト：** 非日常（ハレ）と日常（ケ）の対比で捉える考え方がベース  
> * **Note：** アプリ名は変更の可能性があります（現時点の候補：ケハレ帖）

---

## 💡 このサービスへの思い・作りたい理由
前職でパティシエ／食品製造の現場にいたとき、日々の仕事は「ケ」が多い一方で、ウェディングなど“ハレ”の瞬間は強く記憶に残る体験だと感じていました。  
季節感、香り、盛り付け、最後の一皿の余韻。ほんの小さな差が、その日を「特別な記憶」に変えることを何度も見てきました。

でも生活は基本的に「ケ」が大半で、特別な日を増やしたくても、献立を決めることや片付けが面倒で止まりがちです。  
自分自身も「献立迷い（買い物前に家で迷う）」で時間が溶けるタイプでした。

一方で「新作・限定を選ぶ」「普段より少し予算を上げる」「デザートを足す」「コーヒー／紅茶を合わせる」といった小さな行動で、ケの日でも“プチハレ”は作れる。  
このサービスは、そうした **“ハレを足す行動”を記録・共有し、続けるほど日常が少し楽しくなる体験**を作るために企画しました。

---

## 🎯 ユーザー層について

### メインターゲット
- **属性：** 一人暮らしの個人ユーザー
- **スキル：** 料理初心者（レシピを見れば作れるが、献立決めが負担）
- **生活スタイル：** 自炊多め〜中食多め  
  ※コンビニ弁当／ファストフードは「中食」として扱う
- **利用シーン：** スマホ中心
- **プライバシー：** 個人情報は扱わない（従業員名・健康状態・取引先情報などは扱わない）

> **Note:** 家庭を持っていても使える余地は残しつつ、設計を散らかさないため **MVPは「個人」軸**で作ります。

---

## 🚫 一番潰したい失敗（＝解決したい課題）
**献立迷い（買い物前に家で迷う）**  
「何を作るか決められない」「検索ワードの試行錯誤で疲れる」ことで、時間が溶けたり自炊を諦めてしまう状態。

---

## ユーザーの課題と解決アプローチ

### 課題（ケ）：献立を“決める”のがしんどい
- 何を作るか決められず、買い物前に家で迷って時間が溶ける
- 検索ワードの試行錯誤で疲れる（検索しても決めきれない）

### アプローチ（ケ）：決める工程を「選ぶだけ」に圧縮する
- 入力は選択式（自炊/中食、買い物/家にある、時間、気分）
- アプリが **料理名の候補を3つ提示**し、選択肢を固定する
- 各候補は **ワンタップでGoogle検索結果へ**（検索語入力の手間をなくす）

### 課題（ハレ）：良かった行動が残らず、日常が単調で続かない
- 小さな満足が積み上がらず、日々の「ちゃんとできた」が流れてしまう
- 食の楽しみが継続しづらい（振り返りがない）

### アプローチ（ハレ）：主観でOKの“プチハレ”を記録し、可視化して継続させる
- ハレタグ（ボタン）＋ひとことの短文で記録
- カレンダースタンプ＋ポイント＋見た目変化で「積み上げ」を見える化
- 記録が“自分のネタ帳”になり、次回の迷い軽減（ケ）にもつながる

---

## 📱 サービスの利用イメージ

### ケ（献立迷いを止める）
1. アプリを開き、まず **「自炊／中食」** を選ぶ
2. 自炊の場合は **「今から買いに行く／家にあるもので作る」** も選ぶ
3. 所要時間（10分刻み）と気分タグ（最小セット）を入れる
4. アプリが **料理名の候補を3つ提示**する（例：回鍋肉／親子丼／豚汁）
5. 候補から **ワンタップでGoogle検索結果へ**移動する（検索語入力は不要）
- ※レシピ本文は外部サイトで検索（アプリはレシピDBを抱えない）

### ハレ（ハレを足して残す）
1. 「今日はハレを足した」と感じたら記録する（ハレ判定は主観でOK）
2. **ハレタグ（ボタン）**を選ぶ（例：新作／限定／予算UP）
3. 投稿を「自分だけ／全体公開」で保存
4. カレンダーにスタンプが押され、ポイントと見た目変化が進む

---

## 🎨 UIイメージ（Wireframe）
画面遷移図や開発が進んだら張り替える予定あり。

### ホーム画面
現在の「ハレ度」を確認し、次の行動（検索 or 記録）を選択します。

```text
+-----------------------------------+
|      現在のハレ度: Lv.5 (18pt)    |
|         ( 🌱 ) [  絵  ]           |
|-----------------------------------|
|  [ 今日のごはん、どうする？ ]     |
|   👉 迷いを減らす (ケ)            |
|-----------------------------------|
|  [ 今日、なにか良いことあった？ ] |
|   ✨ ハレを記録する (ハレ)        |
+-----------------------------------+
```

### 献立相談画面（ケ）
最小限の入力で、料理名の候補を3つ提示し、ワンタップで外部検索へ移動します。  
※特定レシピサイトに固定せず、検索結果を入口にすることで、ユーザーが普段使う情報源（レシピサイト/動画等）を選べる設計にしています。

```text
+-----------------------------------+
| 🔍 ごはん相談                     |
|  < スタイル > ( 自炊 ) ( 中食 )   |
|  < 時間 >     10分 --o-- 60分     |
|  < 気分 >     (和食) (ガッツリ)   |
|-----------------------------------|
|       [ 候補を出す 🪄 ]           |
|-----------------------------------|
| 💡 候補: 回鍋肉 / 親子丼 / 豚汁    |
|  [ Googleで回鍋肉を検索 ↗ ]       |
+-----------------------------------+
```

---

## 🌟 サービスの差別化ポイント・推しポイント

### 前提：よくある類似サービス（例）
- レシピ検索/献立提案系：アプリ内でレシピを探す／おすすめを受け取る（検索・提案が主役）
- 栄養管理/食事記録系：摂取量・栄養バランスの記録や改善が主目的（健康が主役）
- 写真/SNS投稿系：食事写真・レビュー・他者反応（いいね等）が主目的（共有が主役）

ケハレ帖（仮）は、上記と一部重なる要素はありつつ、主軸を「迷いの解消」と「プチハレの継続」に置く点が異なります。

### 差別化ポイント1：レシピ提供ではなく「決める工程の圧縮」に集中
- 入力は選択式（自炊/中食、買い物/家にある、時間、気分）
- 料理名の候補を3つ提示（意思決定を圧縮）
- ワンタップでGoogle検索結果へ（検索語入力を不要にする）
- 特定サイトに固定しないため、ユーザーは普段使う情報源（レシピサイト/動画等）を選べる

**この差別化が優れている点**
- 「検索しても決められない」を起こしにくく、最短で行動に移れる
- レシピDBを抱えずに成立するため、MVPでも運用負荷を抑えつつ検証できる

### 差別化ポイント2：「ハレ（小さな特別）」を主観で記録し、日常を育てる
- ハレタグ（新作/限定/予算UPなど）＋短文で記録
- カレンダースタンプ＋ポイント＋見た目変化で積み上げを可視化
- 記録が「自分のハレのネタ帳」になり、次回の迷い（ケ）にも効く

**この差別化が優れている点**
- 完璧な自炊や健康管理を求めず、続けやすい
- “良かった行動”を積み上げられ、モチベーションが持続する

### 推しポイント（このサービスならでは）
- **ケ（迷い軽減）×ハレ（記録/可視化）**のループで、「決められない」→「行動できた」→「残る」→「次が少し楽」の体験を作る
- パティシエ/食品現場の経験を背景に、「季節感・香り・盛り付け・余韻」など“体験としての食”を、ログ体験の設計に落とし込む

---

## 🚀 段階的リリース方針（MVP → β → 本リリース）

### MVP（最小限の実用）
目的：**「記録できる」「振り返れる」「続けられる」**を最短で成立させる
- 認証（新規登録 / ログイン / パスワード再設定）
- ハレ投稿（作成 / 一覧 / 詳細 / 編集 / 削除）
- タグ付け（開発者が用意したタグを付与）
- ポイント付与（足し算のみ）
- ポイント付与（減点ルールなし）
  - ルール定義：point_rules（開発者管理）
  - 付与履歴：point_transactions
  - 表示：今月pt、レベル（簡易）
- カレンダーで振り返り（occurred_on基準）
- 献立相談（条件入力→候補提示→外部検索、検索ログ保存）
  - 候補は「料理名マスタ（seedで投入）」から取得する（レシピ本文は保持しない）

### β（使い続けるための改善＋迷いを減らす）
目的：MVPを実際に使ってもらい、継続率と迷い（離脱）を改善する
- 入力補助（前回入力の引き継ぎ、よく使う条件の候補）
- 検索/絞り込み（投稿やカレンダーをタグ/条件で探しやすく）
- ポイントの納得感（内訳表示：どのルールが適用されたか）
- ルール運用改善（point_rules のactive切替、label/description整備）

### 本リリース（広く使ってもらうための拡張）
- 公開投稿のタイムライン（public投稿閲覧）
- いいね・コメント・ブックマーク
- 画像投稿
- 通報・非表示など安全機能
- 週次/月次レポート（振り返り強化）
- 管理画面（タグ・ジャンル・ポイントルールの編集/並び替え）

### MVP と β の違い（要点）
- MVP：コア体験（迷い軽減×ハレ記録）が成立するかを最優先
- β：実使用で出る「面倒」「分からない」「続かない」を潰す（UX/納得感/運用性が主役）

---

## ✅ MVPで実装する予定の機能（箇条書き）

- ユーザー認証（Devise）
  - 新規登録 / ログイン / ログアウト
  - パスワード再設定（メール送信〜更新）
- ハレ投稿（hare_entries）
  - 投稿の作成 / 一覧 / 詳細
  - 投稿の編集 / 削除
  - 公開範囲：自分だけ／全体公開（全体公開はログイン必須）
  - 本文：280文字以内（調整余地あり）
  - 画像投稿：MVPでは無し
- タグ付け（hare_tags）
  - 投稿に複数タグを付与（hare_entry_tags）
- ポイント付与（足し算運用）
  - 投稿作成/更新時に条件に応じてポイントを付与
  - ルール定義：point_rules（key不変・label変更可・points整数）
  - 付与履歴：point_transactions（point_rule_id + pointsスナップショット）
  - 投稿ごとの合計を hare_entries.awarded_points に反映（表示用キャッシュ）
  - 日次上限：occurred_on 基準で 3pt/日
  - 投稿更新時：当該投稿の point_transactions を一度削除して再評価・再付与する
  - 投稿削除時：当該投稿の point_transactions も削除する
  - ※「減点」は行わない（ただし削除により合計が変動しうる）
- ホーム表示
  - 今月の獲得ポイント合計の表示（point_transactions を月で集計）
  - レベル表示（累計ポイント等から算出：表示のみ）
- カレンダー表示
  - 日付ごとの投稿の表示（occurred_on基準）
  - 投稿詳細に遷移できる
- 献立相談（検索ログ：meal_searches）
  - ジャンル選択（genres）
  - 条件入力（自炊/中食、買い物/家にある、時間、気分 等）
  - 候補提示→外部検索（Google検索結果へ）
   - 候補は「料理名マスタ（seedで投入）」から重複なしで最大3つ提示する
   - 条件に合う候補が不足する場合は、全候補から補完して3つに満たす
  - 検索ログの保存・一覧表示
- マスタデータ（開発者が用意）
  - ハレタグ（hare_tags）：key不変 / label表示名（変更可）
  - 献立ジャンル（genres）：key不変 / label表示名（変更可）
  - ポイントルール（point_rules）：key不変 / label表示名（変更可）/ points と params で条件管理

---

## 🌟 ポイント・見た目段階（MVP中の想定）
### ポイント整合の方針（MVP）
- 日次上限（3pt/日）は、付与時に occurred_on の当日合計を集計し、上限を超えないように調整する。
- 投稿更新時は、当該投稿に紐づく point_transactions を削除してから、is_active な point_rules を priority 順に再評価して再付与する。
- 投稿削除時は、当該投稿に紐づく point_transactions も削除する。
- `hare_entries.awarded_points` は表示用キャッシュとして、作成/更新/削除で必ず同期する。

### 付与ルール（例）
※実装では、数値はコードに直書きせず point_rules（seed）で管理します。
- ハレ投稿： +1（post_base）
- 予算UP（例：500円以上）： 追加 +1（bonus_budget_up / paramsに閾値を持つ）
- 日次上限： 3pt（設定値として管理。コード直書きは避ける）

### 段階（stage）（例）
※段階の閾値も設定値として管理（例：seed/YAMLで管理）
- 0 / 5 / 15 / 30 / 50

---

## 画面遷移図
Figma：https://www.figma.com/design/en5ugBVs09QrvjGpNK411Z/%E3%82%B1%E3%83%8F%E3%83%AC%E5%B8%96?node-id=0-1&t=u5n5VcKf9XwFbOsa-1

---

## 💻 技術スタック・設計運用

### i18n 方針
- アプリのデフォルトロケールは `ja` とする。
- 認証まわり（Devise）の文言は `devise-i18n` を利用して日本語化する。

### 認証メール（パスワード再設定）運用
- パスワード再設定メール等の送信は Resend を利用する。
- メール内URL生成は `APP_HOST`（本番ドメイン）を参照する（`default_url_options` の host）。
- 本番環境で「送信 → 受信 → 更新」までE2E確認を行う。

### バックエンド
| 技術 | 選定理由・妥当性 |
| --- | --- |
| Ruby 3.3.2 | YJITによるパフォーマンス向上と、最新安定版としての実績・保守性を考慮して採用。 |
| Ruby on Rails 8.0 | エコシステムが安定し、Rails単体でモダンなWebアプリを完結できるため採用。 |
| Devise | 認証機能を自作する工数を削減し、MVPの早期リリースを優先するため。 |

### フロントエンド
| 技術 | 選定理由・妥当性 |
| --- | --- |
| Hotwire (Turbo + Stimulus) | SPA導入の学習/開発コストを避けつつ、部分更新で高速な体験を実現するため。 |
| Tailwind CSS + daisyUI | CSS設計コストを削減し、UI構築速度を上げるため。 |
| simple_calendar | MVPでカレンダー表示を短期間で実装し、振り返り体験を成立させるため。 |

### その他・インフラ
| 技術 | 選定理由・妥当性 |
| --- | --- |
| Render | インフラ管理の手間を最小化し、開発に集中するため。 |
| Docker | OS差をなくし、セットアップを統一するため。 |
| Node.js / Yarn | Tailwind等のビルドツール管理用。 |
| PostgreSQL (Neon) | Railsのデファクトであり、サーバーレスでコスト最適化しやすいため。 |
| RSpec | ドキュメントが豊富で、仕様書として読めるテストで保守性を高めるため。 |
| Cloudflare | DNS/ドメイン管理。HTTPS前提の運用とホスト管理を整理するため。 |
| Resend | 認証メール（パスワード再設定等）を本番で安定配信するため。 |

### Turbo/Hotwire と認証フォームについて
- 認証フォーム（Devise）でTurbo起因の挙動差が出る場合は、DeviseフォームのみTurboを無効化して安定動作を優先する（例：`data-turbo="false"`）。

---

## 📂 ディレクトリ構成の主要ポイント
- `app/services/`：外部検索クエリ生成やポイント付与などのビジネスロジック
- `app/javascript/controllers/`：Stimulusコントローラー（UI補助）
- `db/seeds/`：マスタデータ（ハレタグ／ジャンル／ポイントルール）
- 献立候補の料理名も seed で管理する（レシピ本文は保持しない）。必要に応じて検索補助語（例：`base_keywords`）を持たせる。

---

## 🌱 シードデータ（マスタ）の運用方針
- マスタ（hare_tags / genres / point_rules）は `db:seed` で管理する
- 冪等性：`find_or_create_by(key: ...)` 等で重複しないようにする
- マスタ更新：マイグレーションではなく seed を更新し、デプロイ時に `db:seed` を実行する運用

---

## 🗄 DB構造（MVP想定）

### ざっくり方針

- enum想定の項目（公開範囲/食事形態/調理状況）はDB上は integer（Rails enum）で管理する。
- 気分タグ（mood）は将来複数化の可能性があるが、MVPでは検証優先のため「mood_tags をマスタ化 + hare_entries は単一FK（mood_tag_id）」で開始する。
  - 表記ゆれ防止・運用（label変更）を先に実現しつつ、UI/運用コストは抑える。
  - 複数が必要と確定した場合は、中間テーブルを追加し、単一FKをそのまま移行して段階導入する。
- is_active を採用し、booleanであることが分かる命名に統一する。
- meal_searches は「検索結果」ではなく「検索行動ログ」を保持し、履歴表示や改善（よく使われる条件の把握）に活用する。
- point_rules は seed で管理し、投稿作成/更新時に is_active なルールを priority 順に評価して適用、point_transactions に記録する。
- 献立の「候補3つ提示」は、seedで投入した料理名マスタから取得する（レシピ本文は保持しない）。

### ER図（MVP想定）

![Image from Gyazo](https://i.gyazo.com/680b1823266804b955bf005db05780a0.png)

[ER図dbdiagram.io](https://dbdiagram.io/d/Kehare-Cho-697ef474bd82f5fce23dcf53)

 ```mermaid
 erDiagram
   USERS ||--o{ HARE_ENTRIES : has
   HARE_ENTRIES ||--o{ HARE_ENTRY_TAGS : has
   HARE_TAGS ||--o{ HARE_ENTRY_TAGS : has
 
   USERS ||--o{ MEAL_SEARCHES : has
   GENRES ||--o{ MEAL_SEARCHES : used_by
   GENRES ||--o{ MEAL_CANDIDATES : has
 
   USERS ||--o{ POINT_TRANSACTIONS : has
   HARE_ENTRIES ||--o{ POINT_TRANSACTIONS : produces
   POINT_RULES ||--o{ POINT_TRANSACTIONS : applies
 
   MOOD_TAGS ||--o{ HARE_ENTRIES : mood_of
   MOOD_TAGS ||--o{ MEAL_CANDIDATES : mood_of
 
   USERS {
     bigint id PK
     string email "unique, not null"
     string encrypted_password "not null"
     string reset_password_token "unique"
     datetime reset_password_sent_at
     datetime remember_created_at
     datetime created_at
     datetime updated_at
   }
 
   HARE_ENTRIES {
     bigint id PK
     bigint user_id FK
     date occurred_on
 
     integer visibility "enum: private/public"
     integer meal_mode "enum: home_cook/ready_meal"
     integer cook_context "enum: shopping/pantry"
 
     text body "<= 280 chars"
     integer price_yen
     integer awarded_points
 
     bigint mood_tag_id FK "single FK (MVP)"
 
     datetime created_at
     datetime updated_at
   }
 
   HARE_TAGS {
     bigint id PK
     string key "unique, not null (immutable)"
     string label "unique, not null (renameable)"
     integer position
     boolean is_active
     datetime created_at
     datetime updated_at
   }
 
   HARE_ENTRY_TAGS {
     bigint id PK
     bigint hare_entry_id FK
     bigint hare_tag_id FK
   }
 
   GENRES {
     bigint id PK
     string key "unique, not null (immutable)"
     string label "unique, not null (renameable)"
     string base_keywords
     integer position
     boolean is_active
     datetime created_at
     datetime updated_at
   }
 
   MEAL_CANDIDATES {
     bigint id PK
     bigint genre_id FK
     string key "unique, not null (immutable)"
     string label "not null (renameable)"
     integer meal_mode "nullable enum: home_cook/ready_meal"
     integer cook_context "nullable enum: shopping/pantry"
     integer minutes_max
     bigint mood_tag_id FK "nullable"
     integer position
     boolean is_active
     datetime created_at
     datetime updated_at
   }

   MEAL_SEARCHES {
     bigint id PK
     bigint user_id FK
     bigint genre_id FK
     integer meal_mode
     integer cook_context
     integer minutes
     bigint mood_tag_id FK
     string query_text
     datetime created_at
   }
 
   MOOD_TAGS {
     bigint id PK
     string key "unique, not null (immutable)"
     string label "unique, not null (renameable)"
     integer position
     boolean is_active
     datetime created_at
     datetime updated_at
   }
 
   POINT_RULES {
     bigint id PK
     string key "unique, not null (immutable)"
     string label "not null (renameable)"
     integer points "not null"
     json params
     integer priority "not null"
     boolean is_active "not null"
     text description
     datetime created_at
     datetime updated_at
   }
 
   POINT_TRANSACTIONS {
     bigint id PK
     bigint user_id FK
     bigint hare_entry_id FK
     bigint point_rule_id FK
     date occurred_on
     integer points "snapshot"
     datetime created_at
   }